version: "3"
services:
  web:
    build:
      context: ./web
      args:
        NPROCS: 4
        TIMEZONE: Australia/Melbourne
        SECRET_KEY: $SECRET_KEY
        WTF_CSRF_SECRET_KEY: $WTF_CSRF_SECRET_KEY
        MAIL_PASSWORD: $MAIL_PASSWORD
    volumes:
      - ./app:/app
      - ./databases/app.db:/database.db
      - ./uploads:/uploads
      - ./filemaker-import.csv:/filemaker-import.csv
    expose:
      - 8000
  sync:
    build: 
      context: ./sync
      args:
        TIMEZONE: Australia/Melbourne
        CRON: 0 1 * * *  # Run sync at 1am
    volumes:
      - ./databases/app.db:/database.db
      - ./uploads:/uploads
      - ./backups:/backups
      - ./sync-log.txt:/log.txt
  nginx:
    build:
      context: ./nginx
      args:
        TIMEZONE: Australia/Melbourne
    ports:
     - 80:80
     - 443:443
    links:
      - web
    volumes:
      - ./certs/cert.crt:/etc/nginx/certs/cert.crt
      - ./certs/key.key:/etc/nginx/certs/key.key
